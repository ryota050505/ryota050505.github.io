---
title: ミクシルで聴講した「Terraform」のお話についてのメモ書き
imgsrc: blog/terraform-logo.png
description: '代表的なIaCであるTerraformについてのお話を、忘れないようにするための記事です。'
position: 3
category: インフラ
tags: [Terraform]
version: 1.0
fullscreen: true
---

## はじめに

[ミクシル](https://mixil.mixi.co.jp/)とは[株式会社ミクシィ](https://mixi.co.jp/)で働く社員さんが、
ミクシィのコーポレートミッションである **【新しい文化を作る】** という想いのもと、技術やプロダクト等に関して発信しているメディアです。

<br>

そんなミクシルの記事に関してお話しして頂ける、 **「 ミクシル延長線！〜クラウドを扱うエンジニアにとって「Terraform」は必須ツール!?〜」** に参加させていただいたので、そこで話されていた内容を簡単に残しておきます。

<br>

[ミクシルの該当記事はこちら](https://mixil.mixi.co.jp/culture/13330)


<!-- 2011年mixi入社
元々8年SIer
SNSmixiのインフラを3~4年担当
モンストのサーバエンジニアやSREを担当
家族サービス見てねを担当
そこから4年

今はSREグループのマネージャ

Kubernetesの移行やTerraformの導入

トロンボーン拭いたりクラフトビール飲んだりキャンプしたりが好き -->

## Terraformとは

**Terraform** とは、HashiCorpがGo言語で開発し2014年にリリースされた、AWSやGCP等のクラウドサービスの構成をコードで管理できるオープンソースのIaCツールです。  
理想状態を記述する **宣言モデル** が用いられています。（ちなみにRedHat社が開発したIaCツールである **Ansible** は **命令実行モデル** ）

<br>

[公式はこちら](https://www.terraform.io/)

## Terraformのメリットは？

* インフラの手順書をドキュメントで管理するより劇的に楽
  * ドキュメントの内容が古くて動かないなんてことにならない
  * レビューも楽になる
* Goで開発されているからマルチプラットフォームで実行できて、導入が楽
* 主なパブリッククラウドに対応している
  * プロバイダがあればどのクラウドでも可能
* 既に稼働しているクラウドのリソースを後からインポートして管理できる
* HCLという言語を用いて記述
  * ymlやjsonより使いやすい（主観）

<br>

HCLではfor文等もサポートされているので、確かに表現力の幅がymlやjsonより広いなぁと感じました。

<br>

## Q&A的な話

### インフラ環境を手作業で構築していた際に失敗した経験はありますか？

* ミクシィのサービスである「 **みてね** 」で用いられるS3の設定で、特定の環境（prod環境ではない）のイベント設定を間違えて上手く動かなかったことがある
* SQSでも同じ経験あり
* インスタンス等を命名する際にタイポしたり

### IaCのよくある話

* コードで管理されるので、書き方が統一されたりしてドキュメントより見やすくなるし、レビューもしやすくなる

### 導入しなかったら今どうなっていたか

* CloudFormationとかCDKなどもあるので、そっちを導入していたかも
  * でも前職でTerraformを触っていたからやっぱりTerraform
* 恐らく今頃ドキュメントが凄い多くて、しかもメンテナンスが必要になる
  * そこにかける労力が無駄

### どんな場合にTerraformで管理できないケースが発生するの？

* プロバイダが対応していない場合
  * 人気がないリソースやパラメータは対応されていないことが多い
* AWS ChatBotはTerraformで対応していない
  * CloudFormationでは対応できる
    * Terraform→CloudFormation→チャットボットみたいにHack的に管理できたりもする
* AWS Cloud Control APIが2021/9にリリースされた
  * 従来と違うプロバイダで、裏でCloudFormationを使用してる
    * CloudFormationが対応しているAWSリソースにいち早く対応できる

### Terraformを導入する際に気をつけておきたいところ、躓きそうなところ

* ディレクトリ構成やファイルの命名、コードの分割単位が難しい
  * **みてね** のディレクトリ分割例
    * ALBやCloudFrontなど外向きなところで一つのディレクトリ
    * S3やIAMRoleとかサービスに使用されるもので一つのディレクトリ
  * tfStateもこのディレクトリ単位で管理
* workspaceの機能で複数環境でも使えるようにしている
* モジュールに関しては、サービス専用ディレクトリの中で細かく分けて、影響が出ない範囲で疎結合にする

### 実行環境のセキュリティ

**Terraformの権限を誰かに乗っ取られるとAWSを好き勝手に触られてしまう**

<br>

Terraformで管理する対象を減らせばリスクは減るが、Terraformで管理したほうが当たり前にコスパが良い

<br>

* アクセスキーを安易に使用しない等の対応

## 事前質問・当日質問の回答

### IaC導入時に偉い人からデメリット観点で反対された際の論破方法はあるか？

* 導入しない際のデメリット・導入する際のメリットをどれだけ表現できるか

### 複数環境を管理する方法としてモジュールやワークスペースが有るが、複数環境や環境ごとに異なる値はどのように管理されてる？

* TerraformのinputVariablesを使用して変数を管理
* `環境名.tfvars`というファイルで環境ごとに変数設定

### AWS CDKとの比較をお願いします

> **CDKは業務で使用してないから詳しくない前提**

**CDKに関して**

**メリット**

* 色んな言語で書けるのがよい
* チームで知見のある言語が選べる
* ハイレベルコンストラクトで書くと記述量が少ないコードが書ける
* code pipelineがあるから、AWSオンリーで安全なCI/CDが作成できる
* 一貫した操作でLambdaまでカバーできる

<br>

**デメリット**

* AWSオンリーなので、GCPとか色んなパブリッククラウドで使用できない

<br>

**Terraformに関して**

**メリット**

* [上に書いたとおり](#terraformのメリットは)

<br>

**デメリット**

* HCLに関する慣れが必要
* 実行環境は安全にどこで実行すればよいかわからなかったり
  * 実行環境でいうとCodeBuildとかGitHub ActionsとかCircle CIとか
* AWS Lambdaの管理に向いていない
  * Lambda向けに別途Scriptで書いた上でTerraformで書かないと、みたいなことも必要になってしまう

### リソース名などのリファクタ作業で気にしていること

* 愚直にやっている
* 名前の変更は難しく、命名規則のガイドラインを書いても漏れちゃったりすることもある
* Terraformのmvコマンドで名前を変えたりしているが、コマンド打たなくても名前変えたりするのも最近はあるらしい

### 既存のリソースからTerraformにimportしたことがあるか、どうやって行ったか

* Terraform importコマンドの方が確実にできる
  * これがメイン
* importしたときに出来るtfファイルを手直しして管理したことはある
* 複数importする場合は、shファイル書いて一気にimportすることもある
* Terrafomerも使用したことがある

### インフラのCI/CDはどのように行われていますか？

* 昔はcodeBuild使って、Terraformを使用してた
  * codebuildの定義ファイルを誰かに触られるとセキュリティ的に良くなかった
* 今は各AWSアカウントに適応するための専用AWSアカウント（プロビジョニングアカウント）にあるLambdaを実行
  * LambdaからCodeBuildを実行
  * CodeBuildの権限をLambdaに定義
  * Lambdaはプロビジョニングアカウントにある自作ツールからのアクセスしか受け付けない
  * 自作ツールはGitHub WebHookによってKickされる
  * planの内容をツール・Lambda経由でPR、Slackに表示する
  * PRをマージするとプラン結果を実行するか否かをSlackに通知する
  * それをApplyすると反映される

## まとめ

Terraformを使用したことは数回程度しかないのですが、これを機にAWS環境をコードで管理しようと思いました。
